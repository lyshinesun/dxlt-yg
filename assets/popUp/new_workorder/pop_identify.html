<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>验证弹窗</title>
    <link rel="stylesheet" href="../../resource/plugin/layui/css/layui.css"/>
    <link rel="stylesheet" href="../../resource/css/new_workorder/work_pop_common.css"/>
    <link rel="stylesheet" href="../../resource/plugin/My97DatePicker/skin/WdatePicker.css"/>
    <link rel="stylesheet" href="../../resource/css/pager.css"/>
    <link rel="stylesheet" href="../../resource/css/fault.css"/>
</head>
<body>
<div id="pop_identify" class="pop_identify">
    <input id="iden_start" type="text" readonly="readonly" placeholder="开始时间"/>
    <input id="iden_end" type="text" readonly="readonly" placeholder="结束时间"/>
    <input type="hidden" id="psCode" value="">
    <input type="hidden" id="faultId" value="">
    <a href="javascript:;" @click="getIdentify" style="margin-left: 20px">确定</a>

    <div class="identify_table">
        <table class="task_table">
            <thead>
            <th class="fault_tr01">记录时间</th>
            <th class="fault_tr02">组串编号</th>
            <th class="fault_tr03">Avg</th>
            </thead>
            <tbody id="faultList"></tbody>
        </table>
        <div class="no_result">无查询结果！</div>
    </div>

    <!--分页-->
    <div class="clearfix">
        <div id="Paginationother" style="margin-right: 20px;" class="pagination fr Page_other"></div>
    </div>

    <input type="hidden" value="10" id="pageId">
</div>

</body>

<!--故障模板-->
<script type="text/template" id="default_tpl">
    <% for(var i=0;i< resList.length; i++){%>
    <tr>
        <td class="fault_tr02"><%=resList[i].fdLogDate%></td>
        <td class="fault_tr03"><%=resList[i].fdTagName%></td>
        <td class="fault_tr02"><%=resList[i].fdAvgvalue%></td>
    </tr>
    <% }%>

</script>


<script src="../../resource/js/jquery-1.10.2.min.js"></script>
<script src="../../resource/js/lib/vlm.js"></script>
<script src="../../resource/js/lib/vue.js"></script>
<script src="../../resource/js/lib/ejs.js"></script>
<script src="../../resource/js/common/esmpbase.js"></script>
<script src="../../resource/plugin/layer/layer.min.js"></script>
<script src="../../resource/js/common/common_zh_CN.js"></script>
<script src="../../resource/plugin/pager/pager.js"></script>
<script src="../../resource/plugin/My97DatePicker/WdatePicker.js"></script>


<script>
    var vm = new Vue({
        el: '#pop_identify',
        data: {
            startPageFlag: true,
            curOtherPage: 1,
            sizePage: 10,
            chooseTotNum: 0, //总条数
        },
        methods: {
            getIdentify: function () {
                var _this = this;
                if ($('#iden_start').val() == "") {
                    parent.layer.open({
                        title: '提示',
                        content: '请选择开始日期'
                    });
                    return;
                }

                $('.no_result').hide();
                layer.load(0, 2);

                $.ajax({
                    url: vlm.serverAddr + "tbdatastatyc201707/list",	//请求地址
                    dataType: "json",
                    type: "GET",
                    data: {
                        page: this.curOtherPage,
                        limit: this.sizePage,
                        startTime: $('#iden_start').val(),
                        endTime: $('#iden_end').val(),
                        faultId: $('#faultId').val(),
                        vType: 0,
                        psid: $('#psCode').val()
                    },
                    success: function (result) {
                        layer.closeAll();
                        if (result.page.list.length < 1) {
                            $('.no_result').show();
                        }

                        var default_tpl = $('#default_tpl').html();
                        var newStr = ejs.render(default_tpl, {resList: result.page.list});
                        $('#faultList').html(newStr);

                        _this.chooseTotNum = result.page.totalCount;
                        _this.startPageFlag = false;

                        if (_this.curOtherPage > 1 && _this.chooseTotNum <= (_this.curOtherPage - 1) * _this.sizePage) {//总数小于页数*当前页码，页码自动减一
                            _this.curOtherPage = _this.curOtherPage - 1;
                        }

                        _this.pageList();
                    }
                });
            },

            //创建分页
            pageList: function () {
                var _this = this;
                this.sizePage = $('#pageId').val();
                var num_entries = this.chooseTotNum;
                var paramArray = [];
                paramArray.push(num_entries);
                paramArray.push(this.sizePage);
                // 创建分页
                $("#Paginationother").pagination(num_entries, {
                    num_edge_entries: 1,
                    //边缘页数
                    current_page: _this.curOtherPage - 1,
                    num_display_entries: 4,
                    //主体页数
                    callback: pageselectCallback,
                    items_per_page: _this.sizePage,
                    //每页显示1项
                    prev_text: LANG["all_station_previouspage"],
                    next_text: LANG["all_station_nextpage"],
                    /**start 2016 07 06 wangli 添加跳页操作**/
                    page_jump: formatString(LANG["common_pagejump"]),
                    page_confirm: formatString(LANG["common_confirm"]),
                    page_message: formatString(LANG["common_pagemessage"], paramArray, _this.sizePage)

                });

                function pageselectCallback(page_index) {

                    _this.curOtherPage = page_index + 1;
                    if (_this.startPageFlag) { //不是点击分页按钮的时候不调用search方法
                        $("#pageChange").val(_this.curOtherPage);
                        _this.getIdentify();
                    }
                    _this.startPageFlag = true;
                }

                $("#pageChange").val(_this.curOtherPage);
                $('#goPage').click(function () {
                    _this.curOtherPage = $("#pageChange").val();
                    _this.getIdentify();
                });

            },
        },
        mounted: function () {
            $("#iden_start, #iden_end").click(function () {
                WdatePicker({
                    dateFmt: 'yyyy-MM-dd HH:mm:ss',
                    maxDate: '%y/%M/%d',
                    isShowClear: false,
                    readOnly: true,
                    onpicking: function (dp) {
                        //_this.dateChanged(dp.cal.getDateStr(), dp.cal.getNewDateStr());
                    }
                });
            });
        }
    });


    function doChangePage() {
        $('#pageId').val($("#pageNum option:selected").val())
        vm.sizePage = $("#pageNum option:selected").val();
        vm.curOtherPage = 1;
        vm.getIdentify();
    }


</script>
</html>


